<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KaboreTech - Admin</title>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root {
      --primary: #4a6baf;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --dark: #343a40;
      --light: #f8f9fa;
      --gray: #6c757d;
      --border: #ddd;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      display: flex;
      min-height: 100vh;
      background: #f5f5f5;
      color: var(--dark);
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--dark);
      color: white;
      height: 100vh;
      position: fixed;
      padding: 20px 0;
      transition: 0.3s;
    }

    .sidebar-header h3 {
      text-align: center;
      padding: 10px 20px;
      font-size: 1.6rem;
      color: white;
    }

    .sidebar-menu ul {
      list-style: none;
      margin-top: 20px;
    }

    .sidebar-menu a {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: white;
      text-decoration: none;
      font-size: 0.95rem;
      transition: all 0.3s;
    }

    .sidebar-menu a:hover, .sidebar-menu a.active {
      background: rgba(255, 255, 255, 0.1);
      border-left: 3px solid var(--warning);
    }

    .sidebar-menu i {
      margin-right: 12px;
      width: 20px;
      text-align: center;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 260px;
      padding: 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 30px;
    }

    .header h2 {
      color: var(--dark);
      font-weight: 600;
    }

    /* Cards */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      border-top: 4px solid var(--primary);
    }

    .card.paid { border-top-color: var(--success); }
    .card.free { border-top-color: var(--warning); }

    .card h3 {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 8px;
    }

    .card p {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--dark);
    }

    /* Table & List */
    .table-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      padding: 20px;
      margin-bottom: 30px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      background: #f8f9fa;
      font-weight: 600;
      color: var(--dark);
    }

    tr:hover {
      background: #f8f9fa;
    }

    .status {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .status.paid { background: #d4edda; color: var(--success); }
    .status.free { background: #fff3cd; color: var(--warning); }

    .action-btn {
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
      font-size: 0.85rem;
    }

    .edit-btn { background: var(--warning); color: var(--dark); }
    .delete-btn { background: var(--danger); color: white; }
    .reset-btn { background: var(--primary); color: white; }

    /* Form */
    .form-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      padding: 25px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark);
    }

    .form-control {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 1rem;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* Tabs */
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      background: #f8f9fa;
      border: 1px solid var(--border);
      border-bottom: none;
      border-radius: 5px 5px 0 0;
    }

    .tab.active {
      background: white;
      border-bottom: 1px solid white;
      margin-bottom: -1px;
      color: var(--primary);
      font-weight: 500;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Upload Progress */
    .upload-progress {
      margin-top: 15px;
      display: none;
    }

    .progress-bar {
      height: 6px;
      background: #e9ecef;
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: var(--success);
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 0.85rem;
      margin-top: 5px;
      color: var(--gray);
    }

    /* Alert */
    .alert {
      padding: 12px;
      margin-bottom: 15px;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .alert-success {
      background: #d4edda;
      color: var(--success);
      border: 1px solid #c3e6cb;
    }

    .alert-danger {
      background: #f8d7da;
      color: var(--danger);
      border: 1px solid #f5c6cb;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .close {
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      color: #aaa;
    }

    .close:hover {
      color: black;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 70px;
        overflow: hidden;
      }
      .sidebar span {
        display: none;
      }
      .sidebar i {
        font-size: 1.3rem;
        margin-right: 0;
      }
      .main-content {
        margin-left: 70px;
      }
      .cards {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h3>KaboreTech</h3>
    </div>
    <div class="sidebar-menu">
      <ul>
        <li><a href="#" class="active menu-item" data-section="dashboard"><i class="fas fa-tachometer-alt"></i> <span>Tableau de Bord</span></a></li>
        <li><a href="#" class="menu-item" data-section="videos"><i class="fas fa-video"></i> <span>Vidéos</span></a></li>
        <li><a href="#" class="menu-item" data-section="users"><i class="fas fa-users"></i> <span>Utilisateurs</span></a></li>
        <li><a href="#" class="menu-item" data-section="settings"><i class="fas fa-cog"></i> <span>Paramètres</span></a></li>
      </ul>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <h2 id="page-title">Tableau de Bord</h2>
      <div class="user-info">
        <img src="https://ui-avatars.com/api/?name=Admin&background=4a6baf&color=fff" alt="Admin" width="40" height="40" style="border-radius:50%">
        <span style="margin-left:10px">Admin</span>
      </div>
    </div>

    <!-- Dashboard -->
    <section id="dashboard-section" class="section active">
      <div class="cards">
        <div class="card total"><h3>Total Vidéos</h3><p id="total-videos">0</p></div>
        <div class="card paid"><h3>Vidéos Payantes</h3><p id="paid-videos">0</p></div>
        <div class="card free"><h3>Vidéos Gratuites</h3><p id="free-videos">0</p></div>
      </div>

      <div class="table-container">
        <h3>Vidéos Récentes</h3>
        <table id="recent-videos-table">
          <thead>
            <tr>
              <th>Titre</th>
              <th>Catégorie</th>
              <th>Partie</th>
              <th>Type</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="5" class="loading">Chargement...</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- Videos -->
    <section id="videos-section" class="section">
      <div class="tabs">
        <div class="tab active" data-tab="videos-list">Liste des Vidéos</div>
        <div class="tab" data-tab="add-video">Ajouter une Vidéo</div>
      </div>

      <div class="tab-content active" id="videos-list-tab">
        <div class="table-container">
          <table id="videos-table">
            <thead>
              <tr>
                <th>Titre</th>
                <th>Catégorie</th>
                <th>Partie</th>
                <th>Type</th>
                <th>Description</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody><tr><td colspan="6" class="loading">Chargement...</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="tab-content" id="add-video-tab">
        <div class="form-container">
          <h3 id="video-form-title">Ajouter une Vidéo</h3>
          <div id="video-alert"></div>
          <form id="video-form">
            <div class="form-group">
              <label for="title">Titre</label>
              <input type="text" id="title" class="form-control" required />
            </div>

            <div class="form-group">
              <label for="isPaid">Type</label>
              <select id="isPaid" class="form-control" required>
                <option value="false">Gratuite</option>
                <option value="true">Payante</option>
              </select>
            </div>

            <div id="category-group">
              <div class="form-group">
                <label for="category">Catégorie</label>
                <select id="category" class="form-control" required>
                  <option value="">Sélectionner</option>
                  <option value="Informatique">Informatique</option>
                  <option value="Marketing">Marketing</option>
                  <option value="Bureautique">Bureautique</option>
                  <option value="GSM">GSM</option>
                </select>
              </div>

              <div class="form-group">
                <label for="part">Partie</label>
                <select id="part" class="form-control" required>
                  <option value="">Sélectionner</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label for="description">Description</label>
              <textarea id="description" class="form-control" rows="3" required></textarea>
            </div>

            <div class="form-group">
              <label for="videoFile">Vidéo</label>
              <input type="file" id="videoFile" class="form-control" accept="video/*" />
            </div>

            <div class="form-group">
              <label for="imageFile">Image</label>
              <input type="file" id="imageFile" class="form-control" accept="image/*" />
            </div>

            <div class="upload-progress">
              <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
              <div class="progress-text" id="progress-text">0%</div>
            </div>

            <button type="submit" class="btn btn-primary" id="video-submit-btn">Ajouter</button>
            <button type="button" class="btn btn-secondary" id="cancel-edit-btn" style="display:none">Annuler</button>
          </form>
        </div>
      </div>
    </section>

    <!-- Users -->
    <section id="users-section" class="section">
      <div class="tabs">
        <div class="tab active" data-tab="users-list">Liste des Utilisateurs</div>
        <div class="tab" data-tab="add-user">Ajouter</div>
      </div>

      <div class="tab-content active" id="users-list-tab">
        <div class="table-container">
          <table id="users-table">
            <thead>
              <tr>
                <th>Nom</th>
                <th>Téléphone</th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody><tr><td colspan="4" class="loading">Chargement...</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="tab-content" id="add-user-tab">
        <div class="form-container">
          <h3>Ajouter un Utilisateur</h3>
          <div id="user-alert"></div>
          <form id="user-form">
            <div class="form-group">
              <label>Nom</label>
              <input type="text" id="user-name" class="form-control" required />
            </div>
            <div class="form-group">
              <label>Téléphone</label>
              <input type="text" id="user-phone" class="form-control" placeholder="+226 XX XX XX XX" required />
            </div>
            <div class="form-group">
              <label>Mot de passe</label>
              <input type="password" id="user-password" class="form-control" required />
            </div>
            <button type="submit" class="btn btn-primary">Ajouter</button>
          </form>
        </div>
      </div>
    </section>

    <!-- Settings -->
    <section id="settings-section" class="section">
      <div class="form-container">
        <h3>Paramètres</h3>
        <div class="form-group">
          <label>
            <input type="checkbox" id="screen-capture-toggle" />
            Autoriser la capture d'écran
          </label>
        </div>
      </div>
    </section>
  </div>

  <!-- Reset Password Modal -->
  <div id="password-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Réinitialiser le mot de passe</h3>
      <div id="password-alert"></div>
      <form id="password-form">
        <div class="form-group">
          <label>Téléphone</label>
          <input type="text" id="reset-phone" class="form-control" readonly />
        </div>
        <div class="form-group">
          <label>Code OTP</label>
          <input type="text" id="reset-otp" class="form-control" required />
        </div>
        <div class="form-group">
          <label>Nouveau mot de passe</label>
          <input type="password" id="reset-new-password" class="form-control" required />
        </div>
        <button type="submit" class="btn btn-primary">Réinitialiser</button>
        <button type="button" class="btn btn-secondary" id="send-otp-btn">Envoyer OTP</button>
      </form>
    </div>
  </div>

  <script>
    const BASE_URL = 'https://kaboretech.cursusbf.com';
    let currentVideoId = null;

    // DOM Elements
    const sections = {
      dashboard: document.getElementById('dashboard-section'),
      videos: document.getElementById('videos-section'),
      users: document.getElementById('users-section'),
      settings: document.getElementById('settings-section')
    };

    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const menuItems = document.querySelectorAll('.menu-item');
    const pageTitle = document.getElementById('page-title');

    // Category → Parts Mapping
    const partOptions = {
      Informatique: ['Hardware', 'Software'],
      Marketing: ['Social', 'Content'],
      Bureautique: ['Partie1', 'Partie2'],
      GSM: ['Hardware', 'Software']
    };

    // Free video categories (random)
    const freeCategories = Object.keys(partOptions);
    const getRandomCategory = () => freeCategories[Math.floor(Math.random() * freeCategories.length)];
    const getRandomPart = (cat) => partOptions[cat][Math.floor(Math.random() * partOptions[cat].length)];

    // Init
    init();

    function init() {
      initMenu();
      initTabs();
      loadScreenCaptureSetting();
      document.getElementById('isPaid').addEventListener('change', toggleCategoryGroup);
      document.getElementById('category').addEventListener('change', updatePartOptions);
      document.getElementById('video-form').addEventListener('submit', handleVideoSubmit);
      document.getElementById('user-form').addEventListener('submit', handleUserSubmit);
      document.getElementById('password-form').addEventListener('submit', handlePasswordReset);
      document.getElementById('send-otp-btn').addEventListener('click', sendOTP);
      document.getElementById('screen-capture-toggle').addEventListener('change', toggleScreenCapture);
      document.getElementById('cancel-edit-btn').addEventListener('click', cancelEdit);
      document.querySelector('.close').addEventListener('click', closeModal);

      // Load data
      loadDashboardData();
    }

    function initMenu() {
      menuItems.forEach(item => {
        item.addEventListener('click', e => {
          e.preventDefault();
          const section = item.getAttribute('data-section');
          setActiveSection(section);
          if (section === 'dashboard') loadDashboardData();
          if (section === 'videos') loadVideos();
          if (section === 'users') loadUsers();
          if (section === 'settings') loadScreenCaptureSetting();
        });
      });
    }

    function setActiveSection(name) {
      Object.values(sections).forEach(s => s.classList.remove('active'));
      sections[name].classList.add('active');
      menuItems.forEach(i => i.classList.remove('active'));
      document.querySelector(`[data-section="${name}"]`).classList.add('active');
      pageTitle.textContent = document.querySelector(`[data-section="${name}"] span`).textContent;
    }

    function initTabs() {
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.getAttribute('data-tab');
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          tabContents.forEach(c => c.classList.remove('active'));
          document.getElementById(`${tabId}-tab`).classList.add('active');
          if (tabId === 'add-video') resetVideoForm();
        });
      });
    }

    function toggleCategoryGroup() {
      const isPaid = document.getElementById('isPaid').value === 'true';
      document.getElementById('category-group').style.display = isPaid ? 'block' : 'none';
      if (!isPaid) {
        document.getElementById('category').value = getRandomCategory();
        document.getElementById('part').value = getRandomPart(document.getElementById('category').value);
      }
    }

    function updatePartOptions() {
      const cat = document.getElementById('category').value;
      const partSelect = document.getElementById('part');
      partSelect.innerHTML = '<option value="">Sélectionner</option>';
      if (partOptions[cat]) {
        partOptions[cat].forEach(p => {
          const opt = document.createElement('option');
          opt.value = p;
          opt.textContent = p;
          partSelect.appendChild(opt);
        });
      }
    }

    // Dashboard
    async function loadDashboardData() {
      try {
        const res = await fetch(`${BASE_URL}/api/videos`);
        const data = await res.json();
        const total = data.reduce((a, c) => a + c.videos.length, 0);
        const paid = data.reduce((a, c) => a + c.videos.filter(v => v.isPaid).length, 0);
        const free = total - paid;

        document.getElementById('total-videos').textContent = total;
        document.getElementById('paid-videos').textContent = paid;
        document.getElementById('free-videos').textContent = free;

        const tbody = document.getElementById('recent-videos-table').querySelector('tbody');
        tbody.innerHTML = '';
        let count = 0;
        for (const cat of data) {
          for (const video of cat.videos) {
            if (count >= 5) break;
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${video.title}</td>
              <td>${video.categoryId}</td>
              <td>${video.part}</td>
              <td><span class="status ${video.isPaid ? 'paid' : 'free'}">${video.isPaid ? 'Payante' : 'Gratuite'}</span></td>
              <td>
                <button class="action-btn edit-btn" data-id="${video.id}"><i class="fas fa-edit"></i></button>
                <button class="action-btn delete-btn" data-id="${video.id}"><i class="fas fa-trash"></i></button>
              </td>
            `;
            tbody.appendChild(tr);
            count++;
          }
        }
        addVideoActionHandlers();
      } catch (e) {
        console.error(e);
        document.getElementById('recent-videos-table').querySelector('tbody').innerHTML = '<tr><td colspan="5">Erreur</td></tr>';
      }
    }

    // Videos
    async function loadVideos() {
      try {
        const res = await fetch(`${BASE_URL}/api/videos`);
        const data = await res.json();
        const tbody = document.getElementById('videos-table').querySelector('tbody');
        tbody.innerHTML = '';
        data.forEach(cat => {
          cat.videos.forEach(video => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${video.title}</td>
              <td>${video.categoryId}</td>
              <td>${video.part}</td>
              <td><span class="status ${video.isPaid ? 'paid' : 'free'}">${video.isPaid ? 'Payante' : 'Gratuite'}</span></td>
              <td>${video.details.description.substring(0, 50)}...</td>
              <td>
                <button class="action-btn edit-btn" data-id="${video.id}"><i class="fas fa-edit"></i></button>
                <button class="action-btn delete-btn" data-id="${video.id}"><i class="fas fa-trash"></i></button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        });
        addVideoActionHandlers();
      } catch (e) {
        console.error(e);
        document.getElementById('videos-table').querySelector('tbody').innerHTML = '<tr><td colspan="6">Erreur</td></tr>';
      }
    }

    function addVideoActionHandlers() {
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', e => editVideo(e.target.closest('button').dataset.id));
      });
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          if (confirm('Supprimer cette vidéo ?')) {
            deleteVideo(e.target.closest('button').dataset.id);
          }
        });
      });
    }

    async function editVideo(id) {
      try {
        const res = await fetch(`${BASE_URL}/api/videos`);
        const data = await res.json();
        let video = null;
        for (const cat of data) {
          video = cat.videos.find(v => v.id === id);
          if (video) break;
        }
        if (!video) return alert('Vidéo non trouvée');

        currentVideoId = id;
        document.getElementById('title').value = video.title;
        document.getElementById('isPaid').value = video.isPaid;
        document.getElementById('category').value = video.categoryId;
        updatePartOptions();
        document.getElementById('part').value = video.part;
        document.getElementById('description').value = video.details.description;

        document.getElementById('video-form-title').textContent = 'Modifier la Vidéo';
        document.getElementById('video-submit-btn').textContent = 'Mettre à jour';
        document.getElementById('cancel-edit-btn').style.display = 'inline-block';
        document.getElementById('category-group').style.display = 'block';

        document.querySelector('.tab[data-tab="add-video"]').click();
      } catch (e) {
        console.error(e);
        alert('Erreur lors du chargement de la vidéo');
      }
    }

    async function deleteVideo(id) {
      try {
        await fetch(`${BASE_URL}/api/delete-video/${id}`, { method: 'DELETE' });
        showAlert('video-alert', 'Vidéo supprimée', 'success');
        loadVideos();
        loadDashboardData();
      } catch (e) {
        console.error(e);
        showAlert('video-alert', 'Erreur', 'danger');
      }
    }

    async function handleVideoSubmit(e) {
      e.preventDefault();
      const formData = new FormData();
      formData.append('title', document.getElementById('title').value);
      formData.append('isPaid', document.getElementById('isPaid').value);
      formData.append('description', document.getElementById('description').value);

      const isPaid = document.getElementById('isPaid').value === 'true';
      if (isPaid) {
        formData.append('categoryId', document.getElementById('category').value);
        formData.append('part', document.getElementById('part').value);
      } else {
        const cat = getRandomCategory();
        formData.append('categoryId', cat);
        formData.append('part', getRandomPart(cat));
      }

      const videoFile = document.getElementById('videoFile').files[0];
      const imageFile = document.getElementById('imageFile').files[0];
      if (videoFile) formData.append('videoFile', videoFile);
      if (imageFile) formData.append('imageFile', imageFile);

      const url = currentVideoId ? `${BASE_URL}/api/update-video/${currentVideoId}` : `${BASE_URL}/api/add-video`;
      const method = currentVideoId ? 'PUT' : 'POST';

      // Show progress
      const progress = document.querySelector('.upload-progress');
      progress.style.display = 'block';

      const xhr = new XMLHttpRequest();
      xhr.open(method, url, true);
      xhr.upload.addEventListener('progress', e => {
        if (e.lengthComputable) {
          const percent = Math.round((e.loaded / e.total) * 100);
          document.getElementById('progress-fill').style.width = percent + '%';
          document.getElementById('progress-text').textContent = percent + '%';
        }
      });

      xhr.onload = function () {
        if (xhr.status === 200 || xhr.status === 201) {
          const res = JSON.parse(xhr.responseText);
          const msg = currentVideoId ? 'mise à jour' : 'ajoutée';
          showAlert('video-alert', `Vidéo ${msg} avec succès`, 'success');
          resetVideoForm();
          loadVideos();
          loadDashboardData();
          setTimeout(() => document.querySelector('.tab[data-tab="videos-list"]').click(), 1500);
        } else {
          showAlert('video-alert', 'Erreur', 'danger');
        }
        progress.style.display = 'none';
      };

      xhr.onerror = () => {
        showAlert('video-alert', 'Erreur réseau', 'danger');
        progress.style.display = 'none';
      };

      xhr.send(formData);
    }

    function resetVideoForm() {
      document.getElementById('video-form').reset();
      document.getElementById('video-form-title').textContent = 'Ajouter une Vidéo';
      document.getElementById('video-submit-btn').textContent = 'Ajouter';
      document.getElementById('cancel-edit-btn').style.display = 'none';
      currentVideoId = null;
      document.getElementById('category-group').style.display = 'block';
      document.getElementById('progress-fill').style.width = '0%';
      document.getElementById('progress-text').textContent = '0%';
    }

    function cancelEdit() {
      resetVideoForm();
      document.querySelector('.tab[data-tab="videos-list"]').click();
    }

    // Users
    async function loadUsers() {
      try {
        const res = await fetch(`${BASE_URL}/api/users`);
        const data = await res.json();
        const tbody = document.getElementById('users-table').querySelector('tbody');
        tbody.innerHTML = '';
        data.users.forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.name}</td>
            <td>${u.phone}</td>
            <td>${getUserStatus(u)}</td>
            <td><button class="action-btn reset-btn" data-phone="${u.phone}"><i class="fas fa-key"></i></button></td>
          `;
          tbody.appendChild(tr);
        });
        document.querySelectorAll('.reset-btn').forEach(btn => {
          btn.addEventListener('click', () => openPasswordModal(btn.dataset.phone));
        });
      } catch (e) {
        console.error(e);
        document.getElementById('users-table').querySelector('tbody').innerHTML = '<tr><td colspan="4">Erreur</td></tr>';
      }
    }

    function getUserStatus(user) {
      const status = [];
      if (user.status.informatiqueHardware) status.push('Info H');
      if (user.status.informatiqueSoftware) status.push('Info S');
      if (user.status.bureautiqueHardware) status.push('Bureau H');
      if (user.status.bureautiqueSoftware) status.push('Bureau S');
      if (user.status.marketingSocial) status.push('Market S');
      if (user.status.marketingContent) status.push('Market C');
      if (user.status.gsmHardware) status.push('GSM H');
      if (user.status.gsmSoftware) status.push('GSM S');
      return status.length ? status.join(', ') : 'Aucun';
    }

    async function handleUserSubmit(e) {
      e.preventDefault();
      const form = e.target;
      const data = {
        name: form['user-name'].value,
        phone: form['user-phone'].value,
        password: form['user-password'].value
      };
      try {
        const res = await fetch(`${BASE_URL}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (res.ok) {
          showAlert('user-alert', 'Utilisateur ajouté', 'success');
          form.reset();
          loadUsers();
        } else {
          throw new Error();
        }
      } catch (e) {
        showAlert('user-alert', 'Erreur', 'danger');
      }
    }

    // Password Reset
    function openPasswordModal(phone) {
      document.getElementById('reset-phone').value = phone;
      document.getElementById('password-modal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('password-modal').style.display = 'none';
      document.getElementById('password-form').reset();
      document.getElementById('password-alert').innerHTML = '';
    }

    async function sendOTP() {
      const phone = document.getElementById('reset-phone').value;
      try {
        await fetch(`${BASE_URL}/api/forgot-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone })
        });
        showAlert('password-alert', 'OTP envoyé', 'success');
      } catch (e) {
        showAlert('password-alert', 'Erreur', 'danger');
      }
    }

    async function handlePasswordReset(e) {
      e.preventDefault();
      const form = e.target;
      const data = {
        phone: form['reset-phone'].value,
        otp: form['reset-otp'].value,
        newPassword: form['reset-new-password'].value
      };
      try {
        const res = await fetch(`${BASE_URL}/api/reset-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (res.ok) {
          showAlert('password-alert', 'Mot de passe réinitialisé', 'success');
          setTimeout(closeModal, 1500);
        } else {
          throw new Error();
        }
      } catch (e) {
        showAlert('password-alert', 'Erreur', 'danger');
      }
    }

    // Settings
    async function loadScreenCaptureSetting() {
      try {
        const res = await fetch(`${BASE_URL}/api/screen-capture`);
        const data = await res.json();
        document.getElementById('screen-capture-toggle').checked = data.allowScreenCapture;
      } catch (e) {
        console.error(e);
      }
    }

    async function toggleScreenCapture() {
      const enabled = this.checked;
      try {
        await fetch(`${BASE_URL}/api/screen-capture`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ allowScreenCapture: enabled })
        });
        alert(`Capture d'écran ${enabled ? 'activée' : 'désactivée'}`);
      } catch (e) {
        this.checked = !this.checked;
        alert('Erreur');
      }
    }

    // Utils
    function showAlert(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      setTimeout(() => el.innerHTML = '', 5000);
    }
  </script>
</body>
</html>
